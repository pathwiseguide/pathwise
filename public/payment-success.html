<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - Pathwise</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        .payment-success-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 2px 24px rgba(0, 0, 0, 0.04);
            max-width: 500px;
            margin: 60px auto;
            text-align: center;
        }
        .payment-success-container h1 { color: #000; margin-bottom: 15px; }
        .payment-success-container p { color: #333; margin-bottom: 25px; line-height: 1.6; }
        .payment-success-container .btn-primary { margin-top: 10px; }
        .payment-success-container .error { color: #c00; }
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav-header">
            <a href="/" class="logo">
                <span>Pathwise</span>
            </a>
            <div class="nav-links">
                <div id="modulesDropdownWrap" class="nav-modules-dropdown" style="display: none;">
                    <button type="button" id="modulesDropdownBtn" class="dropdown-btn">Tools â–¾</button>
                    <div id="modulesDropdownMenu" class="dropdown-menu"></div>
                </div>
                <a href="/dashboard" id="dashboardLink" style="display: none;">Dashboard</a>
                <a href="/payment" id="plansLink">Pricing</a>
                <a href="/login.html" id="loginLink" class="auth-button">Login</a>
                <button id="logoutButton" class="auth-button" style="display: none;">Logout</button>
            </div>
        </nav>

        <div class="payment-success-container">
            <div id="loadingState">
                <p>Confirming your payment...</p>
            </div>
            <div id="successState" style="display: none;">
                <h1>Payment successful</h1>
                <p>Thank you for your purchase. You now have access to all modules.</p>
                <a id="goToModulesLink" href="/modules?tutorial=1" class="btn-primary">Go to Modules</a>
            </div>
            <div id="errorState" style="display: none;">
                <h1>Something went wrong</h1>
                <p class="error" id="errorText">We couldn't confirm your payment.</p>
                <a href="/payment" class="btn-primary">Back to Plans</a>
            </div>
        </div>
    </div>

    <script>
        (async function() {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session_id');
            const loading = document.getElementById('loadingState');
            const success = document.getElementById('successState');
            const error = document.getElementById('errorState');
            const errorText = document.getElementById('errorText');

            if (!sessionId) {
                loading.style.display = 'none';
                errorText.textContent = 'Missing payment session. If you just paid, try refreshing this page.';
                error.style.display = 'block';
                return;
            }

            try {
                const res = await fetch('/api/payment/verify-session?session_id=' + encodeURIComponent(sessionId), {
                    credentials: 'include'
                });
                const data = await res.json().catch(() => ({}));

                loading.style.display = 'none';
                if (res.ok && data.success) {
                    localStorage.setItem('paymentCompleted', 'true');
                    if (data.paymentDate) localStorage.setItem('paymentDate', data.paymentDate);
                    if (localStorage.getItem('pathwiseTutorialCompleted') !== '1') {
                        localStorage.setItem('pathwiseTutorialPending', '1');
                    }
                    const pl = document.getElementById('plansLink');
                    if (pl) pl.style.display = 'none';
                    success.style.display = 'block';
                } else {
                    errorText.textContent = data.message || 'Could not verify payment. Please contact support if you were charged.';
                    error.style.display = 'block';
                }
            } catch (err) {
                loading.style.display = 'none';
                errorText.textContent = 'Network error. Please try again or contact support.';
                error.style.display = 'block';
            }
        })();
    </script>
    <script src="/nav-modules.js"></script>
</body>
</html>
